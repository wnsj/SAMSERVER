<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jiubo.sam.dao.PaymentDao">

    <!--    收费信息汇总查询-->
    <select id="queryGatherPayment" resultType="java.util.Map">
        ${sql}
    </select>

    <!--    根据患者id查询交费信息-->
    <select id="queryPaymentByPatientId" resultType="com.jiubo.sam.bean.PaymentBean">
        SELECT A.PAYMENT_ID,
               A.PATIENT_ID,
               A.PAYSERVICE_ID,
               A.RECEIVABLE,
               A.ACTUALPAYMENT,
               A.BEGTIME,
               A.ENDTIME,
               A.PAYMENTTIME,
               A.UPDATETIME,
               A.ISUSE,
               B.NAME AS PAYSERVICENAME
        FROM PAYMENT A,
             PAYSERVICE B,
             (
              SELECT MAX(PAYMENTTIME) PAYMENTTIME
              FROM PAYMENT
              WHERE PATIENT_ID = #{patientId}
             ) C
        WHERE A.PAYSERVICE_ID = B.PAYSERVICE_ID
          AND B.ISUSE = 1 AND A.PAYMENTTIME = C.PAYMENTTIME
          AND A.PATIENT_ID = #{patientId}
        UNION ALL
        SELECT 0               AS PAYMENT_ID,
               #{patientId}    AS PATIENT_ID,
               C.PAYSERVICE_ID AS PAYSERVICE_ID,
               0               AS RECEIVABLE,
               0               AS ACTUALPAYMENT,
               NULL            AS BEGTIME,
               NULL            AS ENDTIME,
               NULL            AS PAYMENTTIME,
               NULL            AS UPDATETIME,
               'false'         AS ISUSE,
               C.NAME          AS PAYSERVICENAME
        FROM PAYSERVICE C
        WHERE NOT EXISTS(SELECT * FROM PAYMENT WHERE PAYSERVICE_ID = C.PAYSERVICE_ID AND PATIENT_ID = #{patientId})
          AND C.ISUSE = 1
    </select>

    <!--    添加或修改交费信息-->
    <insert id="addPayment">
        <if test="list != null and list.size() > 0">
            <foreach collection="list" item="item">
                INSERT INTO PAYMENT (PATIENT_ID, PAYSERVICE_ID, RECEIVABLE, ACTUALPAYMENT, BEGTIME, ENDTIME,
                PAYMENTTIME, UPDATETIME, ISUSE)
                VALUES (#{item.patientId}, #{item.payserviceId}, #{item.receivable}, #{item.actualpayment},
                #{item.begtime},#{item.endtime},#{item.paymenttime}, GETDATE(),#{item.isuse});
            </foreach>
        </if>
    </insert>

    <!--    修改交费信息-->
    <update id="updatePayment">
        <if test="list != null and list.size() > 0">
            <foreach collection="list" item="item">
                UPDATE PAYMENT
                SET
                PATIENT_ID = #{item.patientId}
                , PAYSERVICE_ID = #{item.payserviceId}
                , RECEIVABLE = #{item.receivable}
                , ACTUALPAYMENT = #{item.actualpayment}
                , BEGTIME = #{item.begtime}
                , ENDTIME = #{item.endtime}
                , PAYMENTTIME = #{item.paymenttime}
                , UPDATETIME = GETDATE()
                , ISUSE = #{item.isuse}
                WHERE PAYMENT_ID = #{item.paymentId};
            </foreach>
        </if>
    </update>
</mapper>
