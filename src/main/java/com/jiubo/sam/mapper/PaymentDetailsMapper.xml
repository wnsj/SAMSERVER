<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jiubo.sam.dao.PaymentDetailsDao">

    <select id="findByCondition" resultType="com.jiubo.sam.bean.PaymentDetailsBean">
        select ME.*
        ,P.NAME AS patientName
        ,P.SEX AS SEX
        ,P.AGE AS AGE
        ,DEPT.NAME AS DEPT_NAME
        ,P2.PATITYPENAME
        ,M.MITYPENAME
        ,E.EMP_NAME
        ,P3.MONEY AS marginAmount
        ,CASE WHEN P3.MONEY &lt; 0 THEN 1 ELSE 2 END isArrearage
        from PAYMENT_DETAILS ME
        LEFT JOIN PATIENT P ON P.HOSP_NUM = ME.HOSP_NUM
        LEFT JOIN PATIENTTYPE P2 ON P.PATITYPEID = P2.PATITYPEID
        LEFT JOIN PATINET_MARGIN P3 ON P3.HOSP_NUM = ME.HOSP_NUM
        LEFT JOIN MEDICINSURTYPE M ON M.MITYPEID = P.MITYPEID
        LEFT JOIN DEPARTMENT DEPT ON DEPT.DEPT_ID = ME.DEPT_ID
        LEFT JOIN EMPLOYEE E ON E.ID = ME.EMP_ID
        LEFT JOIN PAYMENT F ON F.PATIENT_ID = P.PATIENT_ID
        <where>
            <if test="type != null and type != ''">
                AND ME.TYPE = #{type}
            </if>
            <if test="hospNum != null and hospNum != ''">
                AND ME.HOSP_NUM = #{hospNum}
            </if>
            <if test="patientName != null and patientName != ''">
                AND P.NAME LIKE '%' + #{patientName} + '%'
            </if>
            <if test="deptId != null and deptId != ''">
                AND ME.DEPT_ID = #{deptId}
            </if>
            <if test="deptList != null and deptList.size() > 0">
                AND ME.DEPT_ID IN
                <foreach collection="deptList" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="patiTypeId != null and patiTypeId != ''">
                AND P.PATITYPEID = #{patiTypeId}
            </if>
            <if test="miTypeId != null and miTypeId != ''">
                AND P.MITYPEID = #{miTypeId}
            </if>
            <if test="empId != null and empId != ''">
                AND ME.EMP_ID = #{empId}
            </if>
            <if test="isInHospital != null and isInHospital != ''">
                AND ME.IS_IN_HOSPITAL = #{isInHospital}
            </if>
            <if test="isArrearage != null and isArrearage != ''">
                <choose>
                    <when test="isArrearage == 1">
                        AND P3.MONEY &lt; 0
                    </when>
                    <otherwise>AND P3.MONEY &gt;= 0</otherwise>
                </choose>
            </if>
            <if test="begCreateDate != null">
                AND ME.CREATE_DATE >= #{begCreateDate}
            </if>
            <if test="endCreateDate != null">
                AND ME.CREATE_DATE &lt;= #{endCreateDate}
            </if>
            <if test="begDate != null">
                AND F.PAYMENTTIME >= #{begDate}
            </if>
            <if test="endDate != null">
                AND #{endDate} >= F.PAYMENTTIME
            </if>
            <if test="hosBegDate != null">
                AND P.HOSP_TIME >= #{hosBegDate}
            </if>
            <if test="hosEndDate != null">
                AND P.HOSP_TIME &lt;= #{hosEndDate}
            </if>
        </where>
        <choose>
            <when test="type == null or type == ''">
                order by ME.PD_ID ASC
            </when>
            <otherwise>order by ME.CREATE_DATE DESC</otherwise>
        </choose>
    </select>

    <select id="findPaymentDetailByHos" resultType="com.jiubo.sam.bean.PaymentDetailsBean">
        SELECT
        MEG.HOSP_NUM,
        MEG.MARGIN AS MARGIN_USE,
        MEG.PATIENT AS PATIENT_USE,
        MEG.HOSPITAL AS HOSPITAL_USE,
        P.NAME AS patientName,
        P.SEX AS SEX,
        P.AGE AS AGE,
        P.IN_HOSP AS IN_HOSP,
        P.HOSP_TIME AS CREATE_DATE,
        P2.PATITYPENAME,
        M.MITYPENAME,
        DEPT.NAME AS DEPT_NAME,
        E.EMP_NAME,
        P3.MONEY AS MARGIN_AMOUNT,
        CASE
        WHEN P3.MONEY &lt; 0 THEN
        1 ELSE 2
        END IS_ARREARGE
        FROM
        (
        SELECT
        ME.HOSP_NUM,
        SUM (
        CASE WHEN ME.MARGIN_TYPE = 1 THEN ISNULL( ME.MARGIN_USE, 0 ) ELSE -1*ISNULL( ME.MARGIN_USE, 0 ) END ) MARGIN,
        SUM (
        CASE WHEN ME.MARGIN_TYPE = 1 THEN ISNULL( ME.HOSPITAL_USE, 0 ) ELSE -1*ISNULL( ME.HOSPITAL_USE, 0 ) END )
        HOSPITAL,
        SUM (
        CASE WHEN ME.MARGIN_TYPE = 1 THEN ISNULL( ME.PATIENT_USE, 0 ) ELSE -1*ISNULL( ME.PATIENT_USE, 0 ) END ) PATIENT
        FROM
        PAYMENT_DETAILS ME
        GROUP BY
        ME.HOSP_NUM
        ) MEG
        LEFT JOIN PATIENT P ON P.HOSP_NUM = MEG.HOSP_NUM
        LEFT JOIN PATIENTTYPE P2 ON P.PATITYPEID = P2.PATITYPEID
        LEFT JOIN PATINET_MARGIN P3 ON P3.HOSP_NUM = MEG.HOSP_NUM
        LEFT JOIN MEDICINSURTYPE M ON M.MITYPEID = P.MITYPEID
        LEFT JOIN DEPARTMENT DEPT ON DEPT.DEPT_ID = P.DEPT_ID
        LEFT JOIN EMPLOYEE E ON E.ID = P.EMP_ID
        LEFT JOIN PAYMENT F ON F.PATIENT_ID = P.PATIENT_ID
        LEFT JOIN
        <where>
            <if test="hospNum != null and hospNum != ''">
                AND MEG.HOSP_NUM = #{hospNum}
            </if>
            <if test="patientName != null and patientName != ''">
                AND P.NAME LIKE '%' + #{patientName} + '%'
            </if>
            <if test="deptId != null and deptId != ''">
                AND P.DEPT_ID = #{deptId}
            </if>
            <if test="deptList != null and deptList.size() > 0">
                AND P.DEPT_ID IN
                <foreach collection="deptList" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="patiTypeId != null and patiTypeId != ''">
                AND P.PATITYPEID = #{patiTypeId}
            </if>
            <if test="miTypeId != null and miTypeId != ''">
                AND P.MITYPEID = #{miTypeId}
            </if>
            <if test="empId != null and empId != ''">
                AND P.EMP_ID = #{empId}
            </if>
            <if test="isInHospital != null and isInHospital != ''">
                AND P.IN_HOSP = #{isInHospital}
            </if>
            <if test="isArrearage != null and isArrearage != ''">
                <choose>
                    <when test="isArrearage == 1">
                        AND P3.MONEY &lt; 0
                    </when>
                    <otherwise>AND P3.MONEY &gt;= 0</otherwise>
                </choose>
            </if>
            <if test="hosBegDate != null">
                AND CONVERT(varchar(100), P.HOSP_TIME, 23) >= CONVERT(varchar(100), #{hosBegDate}, 23)
            </if>
            <if test="hosEndDate != null">
                AND CONVERT(varchar(100), P.HOSP_TIME, 23) &lt;= CONVERT(varchar(100), #{hosEndDate}, 23)
            </if>
            <if test="begDate != null">
                AND F.PAYMENTTIME >= #{begDate}
            </if>
            <if test="endDate != null">
                AND #{endDate} >= F.PAYMENTTIME
            </if>
        </where>
        order by P.HOSP_TIME DESC
    </select>

</mapper>
