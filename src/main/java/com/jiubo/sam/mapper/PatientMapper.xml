<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jiubo.sam.dao.PatientDao">
    <!--    查询患者信息-->
    <select id="queryPatient" resultType="com.jiubo.sam.bean.PatientBean">
        SELECT A.PATIENT_ID, A.HOSP_NUM, A.NAME, A.SEX, A.AGE, A.HOSP_TIME,A.PATITYPEID,PATIENTTYPE.PATITYPENAME,
        A.IN_HOSP, A.OUT_HOSP, A.DEPT_ID, A.RECEIVABLE, A.UPDATE_TIME,B.NAME DEPTNAME,A.MITYPEID,MEDICINSURTYPE.MITYPENAME
        FROM PATIENT A
        LEFT JOIN DEPARTMENT B
        ON B.DEPT_ID = A.DEPT_ID
        LEFT JOIN PATIENTTYPE
        ON PATIENTTYPE.PATITYPEID = A.PATITYPEID
        LEFT JOIN MEDICINSURTYPE
        ON MEDICINSURTYPE.MITYPEID = A.MITYPEID
        <where>
            <if test="patientId != null and patientId != ''">
                AND A.PATIENT_ID = #{patientId}
            </if>
            <if test="hospNum != null and hospNum != ''">
                AND A.HOSP_NUM = #{hospNum}
            </if>
        </where>
    </select>

    <!--    新收费信息汇总查询-->
    <select id="queryGatherNewPayment" parameterType="com.jiubo.sam.bean.PatientBean" resultType="com.jiubo.sam.bean.PatientBean">
        SELECT PAT.ENDDATE,PAT.DATEDIFFRENT,PT.PATITYPENAME,MT.MITYPENAME,DEPT.NAME AS deptName,P.*
        FROM
        (SELECT PM.PATIENT_ID,MIN(PM.ENDTIME) AS ENDDATE,DATEDIFF(DAY,GETDATE(),MIN(PM.ENDTIME))  AS DATEDIFFRENT FROM PATIENT P
        LEFT JOIN PAYMENT PM ON PM.PATIENT_ID= P.PATIENT_ID
        WHERE PM.PATIENT_ID IS NOT NULL AND PM.BEGTIME IS NOT NULL
        GROUP BY PM.PATIENT_ID) PAT

        LEFT JOIN PATIENT P ON PAT.PATIENT_ID=P.PATIENT_ID
        LEFT JOIN DEPARTMENT DEPT ON DEPT.DEPT_ID=P.DEPT_ID
        LEFT JOIN PATIENTTYPE PT ON P.PATITYPEID=PT.PATITYPEID
        LEFT JOIN MEDICINSURTYPE MT ON MT.MITYPEID=P.MITYPEID
        <where>
            <if test="hospNum != null and hospNum != ''">
                AND P.HOSP_NUM LIKE '%'+#{hospNum}+'%'
            </if>
            <if test="deptId != null and deptId != ''">
                AND P.DEPT_ID = #{deptId}
            </if>
            <if test="name != null and name != ''">
                AND P.NAME LIKE '%'+#{name}+'%'
            </if>
            <if test="patitypeid != null and patitypeid != ''">
                AND PT.PATITYPEID = #{patitypeid}
            </if>
            <if test="patientId != null and patientId != ''">
                AND P.PATITYPEID = #{patientId}
            </if>
            <if test="mitypeid != null and mitypeid != ''">
                AND MT.MITYPEID = #{mitypeid}
            </if>
        </where>
    </select>

    <!--精确查询患者-->
    <select id="accurateQuery" parameterType="com.jiubo.sam.bean.PatientBean"
            resultType="com.jiubo.sam.bean.PatientBean">
        SELECT * FROM PATIENT
        <where>
            <if test=" hospNum != null and hospNum != ''">
                HOSP_NUM=#{hospNum}
            </if>
        </where>
    </select>
    <!--模糊查询患者-->
    <select id="fuzzyQuery" parameterType="com.jiubo.sam.bean.PatientBean" resultType="com.jiubo.sam.bean.PatientBean">
        SELECT * FROM PATIENT
        <where>
            <if test=" hospNum != null and hospNum != ''">
                HOSP_NUM LIKE '%'+#{hospNum}+'%'
            </if>
        </where>
    </select>
    <!--    添加患者信息-->
    <insert id="addPatient" useGeneratedKeys="true" keyProperty="patientId">
        INSERT INTO PATIENT (HOSP_NUM, NAME, SEX, AGE, HOSP_TIME, IN_HOSP,
                             OUT_HOSP, DEPT_ID, RECEIVABLE, UPDATE_TIME, PATITYPEID, MITYPEID,ACCOUNT_ID)
        VALUES (#{hospNum}, #{name}, #{sex}, #{age}, #{hospTime}, #{inHosp}, #{outHosp}, #{deptId}, #{receivable},
                #{updateTime}, #{patitypeid}, #{mitypeid},#{accountId})
    </insert>

    <!--    插入患者、收费项目、交费记录关系-->
    <insert id="addPatientPayservicePayment">
        INSERT INTO PATIENT_PAYSERVICE (PAYSERVICE_ID, PAYMENT_ID)
        VALUES (#{patientId}, #{payserviceId}, #{paymentId})
    </insert>

    <!--    插入患者基础信息（有则更新，无则插入）-->
    <insert id="saveOrUpdate">
        <if test="list != null and list.size() > 0">
            <foreach collection="list" item="item">
                UPDATE PATIENT
                SET
                <trim suffixOverrides=",">
                    <if test="item.name != null and item.name != ''">
                        NAME = #{item.name} ,
                    </if>
                    <if test="item.sex != null and item.sex != ''">
                        SEX = #{item.sex} ,
                    </if>
                    <if test="item.age != null and item.age != ''">
                        AGE = #{item.age} ,
                    </if>
                    <if test="item.hospTime != null and item.hospTime != ''">
                        HOSP_TIME = #{item.hospTime} ,
                    </if>
                    <if test="item.inHosp != null and item.inHosp != ''">
                        IN_HOSP = #{item.inHosp} ,
                    </if>
                    <if test="item.outHosp != null and item.outHosp != ''">
                        OUT_HOSP = #{item.outHosp} ,
                    </if>
                    <if test="item.deptId != null and item.deptId != ''">
                        DEPT_ID = #{item.deptId} ,
                    </if>
                    <if test="item.receivable != null and item.receivable != ''">
                        RECEIVABLE = #{item.receivable} ,
                    </if>
                    <if test="item.updateTime != null and item.updateTime != ''">
                        UPDATE_TIME = #{item.updateTime} ,
                    </if>
                    <if test="item.patitypeid != null and item.patitypeid != ''">
                        PATITYPEID = #{item.patitypeid} ,
                    </if>
                    <if test="item.mitypeid != null and item.mitypeid != ''">
                        MITYPEID = #{item.mitypeid} ,
                    </if>
                    <if test="item.accountId != null and item.accountId != ''">
                        ACCOUNT_ID = #{item.accountId},
                    </if>
                </trim>
                WHERE HOSP_NUM = #{item.hospNum}
                IF NOT EXISTS (SELECT * FROM PATIENT WHERE HOSP_NUM = #{item.hospNum})
                INSERT INTO PATIENT (HOSP_NUM, NAME, SEX, AGE, HOSP_TIME, IN_HOSP,OUT_HOSP, DEPT_ID, RECEIVABLE,
                UPDATE_TIME,PATITYPEID,MITYPEID,ACCOUNT_ID)
                VALUES (#{item.hospNum}, #{item.name}, #{item.sex}, #{item.age}, #{item.hospTime}, #{item.inHosp},
                #{item.outHosp}, #{item.deptId}, #{item.receivable},GETDATE(),#{item.patitypeid},#{item.mitypeid},#{item.accountId});
            </foreach>
        </if>
    </insert>

</mapper>
